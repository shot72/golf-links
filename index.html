<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>弾道＆番手メモ</title>
  <style>
    :root{--bg:#0f172a;--card:#111827;--muted:#1f2937;--text:#e5e7eb;--sub:#9ca3af;--accent:#22c55e}
    *{box-sizing:border-box}body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Hiragino Kaku Gothic ProN","Noto Sans JP","Yu Gothic UI","Meiryo",sans-serif}
    header{position:sticky;top:0;background:linear-gradient(180deg,rgba(15,23,42,.9),rgba(15,23,42,.6));backdrop-filter: blur(6px);padding:12px 16px;border-bottom:1px solid #1f2937;z-index:10}
    header h1{margin:0;font-size:18px} header small{color:var(--sub)}
    main{padding:16px;display:grid;gap:16px;max-width:900px;margin:0 auto}
    .card{background:var(--card);border:1px solid var(--muted);border-radius:16px;padding:14px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .row-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
    label{font-size:12px;color:var(--sub);display:block;margin-bottom:4px}
    input,select,textarea,button{width:100%;padding:10px;border-radius:12px;border:1px solid #334155;background:#0b1220;color:var(--text)}
    textarea{min-height:64px;resize:vertical}
    button{cursor:pointer;font-weight:600}
    .primary{background:var(--accent);color:#07210f;border:0}
    .ghost{background:#0b1220;border:1px dashed #334155}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap}
    .pill{display:inline-flex;gap:8px;flex-wrap:wrap}
    .tag{padding:6px 10px;border-radius:999px;border:1px solid #334155;background:#0b1220;color:var(--sub);font-size:12px}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid #223047;padding:8px;text-align:left;font-size:13px}
    th{color:#cbd5e1}
    tr:hover{background:#0b1220}
    .stat{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
    .stat .box{background:#0b1220;border:1px solid #334155;border-radius:12px;padding:10px}
    .right{justify-self:end}
    .muted{color:var(--sub)}
    @media (max-width:640px){.row,.row-3{grid-template-columns:1fr}}
  </style>
</head>
<body>
<header>
  <h1>弾道＆番手メモ <small>（ローカル保存・オフライン可）</small></h1>
</header>
<main>
  <section class="card" id="form-card">
    <div class="row">
      <div>
        <label for="date">日付</label>
        <input type="date" id="date">
      </div>
      <div>
        <label for="club">番手</label>
        <select id="club"></select>
      </div>
    </div>
    <div class="row-3" style="margin-top:10px">
      <div>
        <label for="height">高さ</label>
        <select id="height">
          <option value="高">高</option>
          <option value="中" selected>中</option>
          <option value="低">低</option>
        </select>
      </div>
      <div>
        <label for="start">打ち出し方向</label>
        <select id="start">
          <option value="左">左</option>
          <option value="センター" selected>センター</option>
          <option value="右">右</option>
        </select>
      </div>
      <div>
        <label for="curve">曲がり</label>
        <select id="curve">
          <option value="ストレート" selected>ストレート</option>
          <option value="ドロー">ドロー</option>
          <option value="フェード">フェード</option>
          <option value="フック">フック</option>
          <option value="スライス">スライス</option>
        </select>
      </div>
    </div>
    <div class="row-3" style="margin-top:10px">
      <div>
        <label for="strike">打点</label>
        <select id="strike">
          <option value="センター" selected>センター</option>
          <option value="薄い(トップ)">薄い(トップ)</option>
          <option value="ダフリ">ダフリ</option>
          <option value="トゥ">トゥ</option>
          <option value="ヒール">ヒール</option>
        </select>
      </div>
      <div>
        <label for="carry">キャリー(任意・yd)</label>
        <input type="number" inputmode="decimal" id="carry" placeholder="例: 155">
      </div>
      <div>
        <label for="quality">出来（主観）</label>
        <select id="quality">
          <option value="◎">◎</option>
          <option value="○" selected>○</option>
          <option value="△">△</option>
          <option value="×">×</option>
        </select>
      </div>
    </div>
    <div style="margin-top:10px">
      <label for="note">メモ</label>
      <textarea id="note" placeholder="風、ライ、狙い、反省点など"></textarea>
    </div>
    <div class="toolbar" style="margin-top:12px">
      <button class="primary" id="add">記録する</button>
      <button class="ghost" id="clearForm">入力クリア</button>
    </div>
    <div class="pill" style="margin-top:10px">
      <span class="tag">保存先: この端末のブラウザ(LocalStorage)</span>
      <span class="tag">通信不要</span>
      <span class="tag">データは端末内のみ</span>
    </div>
  </section>

  <section class="card">
    <div class="toolbar" style="justify-content:space-between;align-items:center">
      <strong>最近の記録</strong>
      <div class="toolbar">
        <button id="exportBtn">CSVエクスポート</button>
        <label class="tag" style="cursor:pointer">CSVインポート<input type="file" id="importFile" accept=".csv" style="display:none"></label>
        <button id="wipe" style="color:#ef4444;border-color:#ef4444">すべて削除</button>
      </div>
    </div>
    <div style="overflow:auto;margin-top:8px">
      <table id="logTable">
        <thead>
          <tr>
            <th>日付</th><th>番手</th><th>高さ</th><th>打ち出し</th><th>曲がり</th><th>打点</th><th>出来</th><th>キャリー(yd)</th><th>メモ</th><th></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <section class="card">
    <strong>番手別サマリー</strong>
    <div id="stats" class="stat" style="margin-top:8px"></div>
    <p class="muted" style="margin-top:6px">※ キャリー平均は数値入力があるデータのみで計算</p>
  </section>
</main>

<script>
const CLUBS = [
  "DR(1W)","3W","5W","7W","3U","4U","5U",
  "3I","4I","5I","6I","7I","8I","9I","PW","AW","SW","LW"
];

const els = {
  date: document.getElementById('date'),
  club: document.getElementById('club'),
  height: document.getElementById('height'),
  start: document.getElementById('start'),
  curve: document.getElementById('curve'),
  strike: document.getElementById('strike'),
  carry: document.getElementById('carry'),
  quality: document.getElementById('quality'),
  note: document.getElementById('note'),
  add: document.getElementById('add'),
  clearForm: document.getElementById('clearForm'),
  tableBody: document.querySelector('#logTable tbody'),
  stats: document.getElementById('stats'),
  exportBtn: document.getElementById('exportBtn'),
  importFile: document.getElementById('importFile'),
  wipe: document.getElementById('wipe')
};

// セレクト初期化
CLUBS.forEach(c=>{const o=document.createElement('option');o.value=o.textContent=c;els.club.appendChild(o)});

function today(){
  const d=new Date();
  const tzOffset = d.getTimezoneOffset();
  // JSTのユーザーが多い想定だが、ローカルのタイムゾーンでOK
  return new Date(d.getTime()-tzOffset*60000).toISOString().slice(0,10);
}

function getData(){
  try{ return JSON.parse(localStorage.getItem('golfShots')||'[]'); }catch{ return [] }
}
function setData(arr){ localStorage.setItem('golfShots', JSON.stringify(arr)); }

function addShot(){
  const rec = {
    id: crypto.randomUUID(),
    date: els.date.value || today(),
    club: els.club.value,
    height: els.height.value,
    start: els.start.value,
    curve: els.curve.value,
    strike: els.strike.value,
    carry: els.carry.value? Number(els.carry.value): null,
    quality: els.quality.value,
    note: els.note.value.trim()
  };
  const arr = getData();
  arr.unshift(rec);
  setData(arr);
  render();
  clearForm();
}

function clearForm(){
  els.date.value = today();
  els.club.value = '7I';
  els.height.value='中';
  els.start.value='センター';
  els.curve.value='ストレート';
  els.strike.value='センター';
  els.carry.value='';
  els.quality.value='○';
  els.note.value='';
}

function del(id){
  const arr = getData().filter(x=>x.id!==id);
  setData(arr); render();
}

function render(){
  const arr = getData();
  // テーブル
  els.tableBody.innerHTML = arr.map(r=>`
    <tr>
      <td>${r.date}</td>
      <td>${r.club}</td>
      <td>${r.height}</td>
      <td>${r.start}</td>
      <td>${r.curve}</td>
      <td>${r.strike}</td>
      <td>${r.quality}</td>
      <td>${r.carry??''}</td>
      <td>${(r.note||'').replace(/</g,'&lt;')}</td>
      <td class="right"><button onclick="del('${r.id}')">削除</button></td>
    </tr>
  `).join('');

  // サマリー
  const byClub = new Map();
  for(const r of arr){
    if(!byClub.has(r.club)) byClub.set(r.club,{n:0,good:0,carryList:[],left:0,center:0,right:0});
    const o = byClub.get(r.club);
    o.n++;
    if(r.quality==='◎' || r.quality==='○') o.good++;
    if(typeof r.carry==='number') o.carryList.push(r.carry);
    if(r.start==='左') o.left++; else if(r.start==='右') o.right++; else o.center++;
  }
  const boxes = [];
  for(const [club,o] of byClub){
    const avg = o.carryList.length? (o.carryList.reduce((a,b)=>a+b,0)/o.carryList.length).toFixed(1): '-';
    const goodRate = o.n? Math.round(o.good/o.n*100): 0;
    boxes.push(`<div class="box"><strong>${club}</strong><div class="muted">記録:${o.n}  良好:${goodRate}%  平均Carry:${avg}yd</div><div class="muted">打ち出し 左:${o.left} 中:${o.center} 右:${o.right}</div></div>`);
  }
  els.stats.innerHTML = boxes.join('');
}

function exportCSV(){
  const arr = getData();
  const head = ["id","date","club","height","start","curve","strike","quality","carry","note"];
  const rows = [head.join(',')].concat(arr.map(r=> head.map(k=>{
    let v = (r[k]??'');
    if(typeof v === 'string'){
      v = '"'+v.replaceAll('"','""')+'"';
    }
    return v;
  }).join(',')));
  const blob = new Blob([rows.join('\n')],{type:'text/csv;charset=utf-8'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'golf_shots.csv'; a.click();
  URL.revokeObjectURL(url);
}

function importCSV(file){
  const reader = new FileReader();
  reader.onload = e=>{
    const text = e.target.result; 
    const lines = text.split(/\r?\n/).filter(Boolean);
    const [headerLine, ...dataLines] = lines;
    const headers = headerLine.split(',').map(s=>s.replace(/^"|"$/g,''));
    const idx = Object.fromEntries(headers.map((h,i)=>[h,i]));
    const arr = getData();
    for(const line of dataLines){
      const cols = line.match(/(?:"[^"]*"|[^,])+/g).map(s=>s.replace(/^"|"$/g,'').replace(/""/g,'"'));
      const rec = {
        id: cols[idx.id] || crypto.randomUUID(),
        date: cols[idx.date] || today(),
        club: cols[idx.club] || '7I',
        height: cols[idx.height] || '中',
        start: cols[idx.start] || 'センター',
        curve: cols[idx.curve] || 'ストレート',
        strike: cols[idx.strike] || 'センター',
        quality: cols[idx.quality] || '○',
        carry: cols[idx.carry]? Number(cols[idx.carry]): null,
        note: cols[idx.note] || ''
      };
      arr.unshift(rec);
    }
    setData(arr); render();
  };
  reader.readAsText(file);
}

function wipeAll(){
  if(confirm('すべての記録を削除します。よろしいですか？')){ setData([]); render(); }
}

// 初期化
clearForm();
render();

// デフォで今日
els.date.value = today();

// イベント
els.add.addEventListener('click', addShot);
els.clearForm.addEventListener('click', clearForm);
els.exportBtn.addEventListener('click', exportCSV);
els.importFile.addEventListener('change', e=>{
  const f=e.target.files?.[0]; if(f) importCSV(f);
  e.target.value='';
});
els.wipe.addEventListener('click', wipeAll);
</script>
</body>
</html>
